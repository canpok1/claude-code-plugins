# AI開発チーム・オートメーション仕様書

## 1. チーム構成と役割 (Roles)

| ロール名 | 役割 | 責任範囲 |
| :--- | :--- | :--- |
| **PdM (User)** | プロダクトマネージャー | 要望の提示、仕様の最終承認、成果物の検収。 |
| **PO (Agent)** | プロダクトオーナー | PdMとの対話、仕様書の作成・更新、ステータス管理。 |
| **TL (Agent)** | テックリード | システム設計、タスク分割、コードレビュー、マージ、競合発生時の差し戻し。 |
| **Dev A/B (Agent)** | デベロッパー | 担当タスクの実装、ユニットテスト、最新コードの同期、レビュー依頼。 |

## 2. ディレクトリ構造

Proposal
```text
/project-root
├── .my-workflow/              # ワークフロー実行基盤（setupスキルにより生成）
│   ├── members/               # エージェント一覧（setupスキルにより生成）
│   │   ├── PO_{エージェント名}.md  # POエージェントの情報（起動スクリプトにより生成）
│   │   ├── TL_{エージェント名}.md  # TLエージェントの情報（起動スクリプトにより生成）
│   │   └── DEV_{エージェント名}.md # Devエージェントの情報（起動スクリプトにより生成）
│   ├── scripts/               # スクリプトディレクトリ（setupスキルにより生成）
│   │   ├── run-po.sh          # POエージェントの起動スクリプト（setupスキル配下のものと同一）
│   │   ├── run-tl.sh          # TLエージェントの起動スクリプト（setupスキル配下のものと同一）
│   │   └── run-dev.sh         # Devエージェントの起動スクリプト（setupスキル配下のものと同一）
│   └── work/                  # 作業用ディレクトリ（setupスキルにより生成）
│       ├── designs/           # 仕様書置き場（setupスキルにより生成）
│       │   └── draft/, todo/, in_progress/, review/, done/
│       │       └── D{ID}_{TITLE}.md  # 仕様書ファイル
│       └── tasks/             # タスク置き場（setupスキルにより生成）
│       │   └── draft/, todo/, in_progress/, review/, done/
│       │       └── D{ID}_T{ID}_{エージェント名}_{TITLE}.md  # タスクファイル
│       ├── proposals/         # 提案書置き場（setupスキルにより生成）
│       │   └── draft/, todo/, review/, approve/, reject/
│       │       └── P{ID}_{TITLE}.md  # 提案ファイル
│       └── questions/         # PdMへの質問事項置き場（setupスキルにより生成）
│           └── draft/, open/, answered/, resolved/
├── plugins/
│   └── my-workflow/           # Claude Code プラグイン
│       ├── .claude-plugin/    # プラグイン定義
│       │   └── plugin.json
│       ├── agents/            # サブエージェント定義
│       │   ├── product-owner.md
│       │   ├── tech-lead.md
│       │   └── developer.md
│       └── skills/            # スキル定義
│           ├── setup/         # 初期設定スキル
│           │   ├── SKILL.md
│           │   └── scripts/
│           │       ├── run-po.sh   # POエージェントの起動スクリプト
│           │       ├── run-tl.sh   # TLエージェントの起動スクリプト
│           │       └── run-dev.sh  # Devエージェントの起動スクリプト
│           ├── request  # 開発チームに対する要望を仕様に落とし込む（PO向け）
│           │   └── SKILL.md
│           ├── interview  # 質問内容をPdMに確認する（PO向け）
│           │   └── SKILL.md
│           ├── breakdown  # 仕様書をもとにタスクを作成する（TL向け）
│           │   └── SKILL.md
│           ├── review-task  # タスクの作業結果をレビューする（TL向け）
│           │   └── SKILL.md
│           └── running-task  # タスクを進める（Dev向け）
│               └── SKILL.md
├── src/                     # メインソースコード
└── .claude/                 # Claude Code 設定

{任意}/  # エージェント用の作業ディレクトリ（起動スクリプトにより生成）
```

## 3. 並行開発と作業スペースの運用

### 3.1 外部ワークスペース (Git Worktree)

各Devエージェントは、project-root とは別の独立したディレクトリで作業を行う。

- **場所** : スクリプト起動時に引数として指定。
- **同期** : 作業開始時に必ず `git pull origin main` を実行し、最新の状態からブランチを切る（最新化の強制）。
- **分離** : 各worktree内に個別の `.claude/` セッションを保持する。

### 3.2 状態管理（フォルダベースのステータス遷移）

エージェントは指定フォルダへのファイル移動をトリガーに自律動作する。

#### 仕様 (Designs) 遷移フロー

1. draft: POが作成し、PdMの承認を待つ。
2. todo: PdMが承認し、移動。TLによるタスク分割待ち。
3. in_progress: TLが検知して移動。このフェーズで `tasks/todo` にタスクが生成される。
4. review: TLが全タスクの完了を確認して移動。PdMによる最終検収待ち。
5. done: PdMが承認し、最終完了。

#### タスク (Tasks) 遷移フロー 

1. draft: TLが生成。依存タスクの作業完了待ち。
2. todo: TLが移動。Devの着手待ち。
2. in_progress: Devが検知して移動。実装着手中。
3. review: Devがコミット完了後に移動。TLによるレビュー・マージ待ち。
4. done: TLがマージ完了後に移動。

#### 提案 (Proposals) 遷移フロー 

1. draft: PO, TL, Devが生成。作成中。
2. todo: 作成者が移動。TLの確認待ち。
3. review: TLが検知して移動。TLによるレビュー中。
4. approve: レビュー結果が承認の場合、TLがレビュー完了後に移動。
5. reject: レビュー結果が却下の場合、TLがレビュー完了後に移動。


#### 質問 (Questions) 遷移フロー 

1. draft: TLが作成中。
2. open: TLが移動。PdMからの回答待ち。
3. answered: PdMから回答を得られたらPOが移動。TLの確認待ち。
4. resolved: TLが回答を確認して疑問が解決したらTLが移動。

## 4. コミュニケーション・プロトコル

### 4.1 エスカレーション & コンフリクト

- **仕様の矛盾** : TLが矛盾を検知した場合、POを通じてPdMに相談。
- **コンフリクト解決** : TLはマージ時に競合を検知した場合、自力で修正せず、該当タスクファイルに競合情報を追記して `tasks/todo` に戻す（担当Devへの差し戻し）。

### 4.2 命名規則

- **仕様書** : `D{design-ID}_{Title}.md` (例: `D001_Login-System.md` )
- **タスク** : `D{design-ID}_T{task-ID}_{Assignee}_{Title}.md` (例: `D001_T001_dev-a_Auth-Logic.md` )
- **提案** : `P{proposal-ID}_{Title}.md` (例: `P001_Update-Skill.md` )

### ファイル内容

- いずれもフロントマター付きのmarkdown形式とする。

#### 仕様書

- フロントマター
- 本文
    - 仕様内容

#### タスク

- フロントマター
    - **branch** : ブランチ名
- 本文
    - 作業内容
    - チェックリスト

#### 提案

- フロントマター
- 本文
    - 提案内容

## 5. Claude Code プラグイン実装仕様

### 5.1 setupスキル

1. `.my-workflow` とそのサブディレクトリを作成。
2. setupスキル配下のscriptsディレクトリ内スクリプトを `.my-workflow` にコピー。

### 5.2 PO向け自動実行スクリプト ( `run-po.sh` ) の責務

1. 引数で下記を受け取る
    - プロジェクトルートのパス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでにPOのファイルがある場合は終了
    - 自身のエージェント名のファイルがある場合も終了
3. ユーザー向けメッセージを表示
    - 「開発チームに対する要望があれば入力してください」
4. 対象ディレクトリとユーザー入力を監視
    - 監視対象（いずれもプロジェクトルート直下）
        - 質問置き場: `.my-workflow/work/questions/open`
        - エージェント一覧置き場: `.my-workflow/members`
5. 質問ファイルを見つけたら下記を実施
    1. 質問に対する回答をユーザーに求める
        - `claude "/interview {質問ファイルのパス}"`
        - 回答を得られたら質問ファイルに回答を追記してansweredディレクトリに移動
    2. 「ユーザー向けメッセージを表示」に戻り再開
6. ユーザーから入力があったら下記を実施
    1. 要望を詳細化
        - `claude "/request {ユーザーからの入力}"`
    2. 「ユーザー向けメッセージを表示」に戻り再開
7. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了

### 5.3 TL向け自動実行スクリプト ( `run-tl.sh` ) の責務

1. 引数で下記を受け取る
    - プロジェクトルートのパス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでにTLのファイルがある場合は終了
    - 自身のエージェント名のファイルがある場合も終了
3. 対象ディレクトリを監視
    - 監視対象（いずれもプロジェクトルート直下）
        - 回答済みの質問ファイル置き場: `.my-workflow/work/questions/answered`
        - レビュー待ちのタスクファイル置き場: `.my-workflow/work/designs/review`
        - 未着手の仕様書置き場: `.my-workflow/work/designs/todo`
        - エージェント一覧置き場: `.my-workflow/members`
4. 回答済みの質問ファイルを見つけたら下記を実施
    1. 回答を確認してタスクを再開
        - `claude --dangerously-skip-permissions -p "/resume {質問ファイルのパス}"`
        - 追加の質問がある場合は質問ファイルに質問を追記しopenディレクトリに移動する
        - 追加質問がなくタスク再開できるなら質問ファイルをresolvedディレクトリに移動する
            - 質問の元になった仕様書・タスクファイルに情報を追記し、todoディレクトリに移動する
                - 仕様書・タスクファイルは質問ファイルを参照
5. レビュー待ちのタスクファイルを見つけたら下記を実施
    1. レビュー開始
        - `claude --dangerously-skip-permissions -p "/review-task {仕様書ファイルのパス}"`
        - 作業結果を確認する
            - 作業結果に問題がなければmainブランチにマージして作業ブランチを削除する
                - 今回の作業完了により作業開始できるタスクがあれば、todoディレクトリに移動する
            - 作業結果に問題があれば問題の対応を行うタスクを新規作成する
                - 新規作成のタスクファイルに記載する作業ブランチはレビューしたタスクの作業ブランチと同じ
    2. タスクファイルを完了ディレクトリ( `.my-workflow/work/tasks/done` )に移動
    3. 監視に戻る
6. 未着手の仕様書ファイルを見つけたら下記を開始
    1. 仕様書ファイルを作業中ディレクトリ( `.my-workflow/work/designs/in_progress` )に移動
    2. タスクへの細分化を実施
        - `claude --dangerously-skip-permissions -p "/breakdown {仕様書ファイルのパス}"`
        - タスクファイルをdraftディレクトリに作成し、全て作成し終えたら着手可能なものをtodoディレクトリに移動する
        - PdMへの質問が必要な場合は質問ファイルを質問置き場（ `.my-workflow/work/questions/draft` ）に作成する
            - 質問ファイルは作成できたら open ディレクトリに移動する
            - 仕様書ファイルは draft ディレクトリに移動する。
    3. 監視に戻る
7. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了

### 5.4 Dev向け自動実行スクリプト ( `run-dev.sh` ) の責務

1. 引数で下記を受け取る。
    - プロジェクトルートのパス
    - 作業ディレクトリ置き場のバス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでに自身のエージェント名のファイルがある場合は終了
4. 対象ディレクトリを監視
    - 監視対象（いずれもプロジェクトルート直下）
        - タスクファイル置き場: `.my-workflow/work/tasks/todo`
        - エージェント一覧置き場: `.my-workflow/members`
5. ファイル名に自身のエージェント名が含まれるタスクファイルを見つけたら下記を開始
    1. タスクファイルを作業中ディレクトリ( `.my-workflow/work/tasks/in_progress` )に移動
    2. 作業用ディレクトリを作成
        - `git worktree add {作業用ディレクトリのパス} {ブランチ名}`
        - 作業用ディレクトリのパス: `{作業ディレクトリ置き場}/{エージェント名}`
        - ブランチ名: タスクファイルに記載があればそのブランチを使用、記載がなければブランチを新規作成
            - 新規作成のブランチ名: `feature/{エージェント名}/{生成したUUID}`
    3. 作業ディレクトリに移動
    4. タスクの作業開始
        - `claude --dangerously-skip-permissions -p "/running-task {タスクファイルのパス}"`
        - 作業結果はタスクファイルに追記する
        - 必要に応じてコミットする
    5. プロジェクトルートに移動
    6. 作業用ディレクトリを削除
        - `git worktree remove {作業用ディレクトリのパス}`
    7. タスクファイルをレビューディレクトリ( `.my-workflow/work/tasks/review` )に移動
    8. 監視に戻る
6. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了
