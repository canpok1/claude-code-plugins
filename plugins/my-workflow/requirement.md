# AI開発チーム・オートメーション仕様案

## 0. 概要

### 目的

Claude Codeプラグインを活用し、PO（プロダクトオーナー）・TL（テックリード）・Dev（デベロッパー）の各AIエージェントが自律的に協調動作することで、PdM（プロダクトマネージャー）の要望から実装・レビュー・マージまでの開発プロセスを自動化する。

### スコープ

- **対象** : Claude Codeプラグインとしてのワークフロー定義、エージェント間の協調プロトコル、状態管理、スクリプト仕様。
- **対象外** : アプリケーション本体の設計・実装内容、CI/CDパイプライン、デプロイメント。

## 1. チーム構成と役割 (Roles)

| ロール名 | 役割 | 責任範囲 |
| :--- | :--- | :--- |
| **PdM (User)** | プロダクトマネージャー | 要望の提示、仕様の最終承認、成果物の検収。 |
| **PO (Agent)** | プロダクトオーナー | PdMとの対話、仕様書の作成・更新、ステータス管理。 |
| **TL (Agent)** | テックリード | システム設計、タスク分割、コードレビュー、マージ、競合発生時の差し戻し。 |
| **Dev A/B (Agent)** | デベロッパー | 担当タスクの実装、ユニットテスト、最新コードの同期、レビュー依頼。 |

## 2. ディレクトリ構造

```text
/project-root
├── .my-workflow/              # ワークフロー実行基盤（setupスキルにより生成）
│   ├── members/               # エージェント一覧（setupスキルにより生成）
│   │   ├── PO_{エージェント名}.md  # POエージェントのマーカーファイル（起動スクリプトにより生成）
│   │   ├── TL_{エージェント名}.md  # TLエージェントのマーカーファイル（起動スクリプトにより生成）
│   │   └── DEV_{エージェント名}.md # Devエージェントのマーカーファイル（起動スクリプトにより生成）
│   ├── scripts/               # スクリプトディレクトリ（setupスキルにより生成）
│   │   ├── run-po.sh          # POエージェントの起動スクリプト（setupスキル配下のものと同一）
│   │   ├── run-tl.sh          # TLエージェントの起動スクリプト（setupスキル配下のものと同一）
│   │   └── run-dev.sh         # Devエージェントの起動スクリプト（setupスキル配下のものと同一）
│   └── work/                  # 作業用ディレクトリ（setupスキルにより生成）
│       ├── designs/           # 仕様書置き場（setupスキルにより生成）
│       │   └── draft/, todo/, in_progress/, review/, done/
│       │       └── D{ID}_{TITLE}.md  # 仕様書ファイル
│       ├── tasks/             # タスク置き場（setupスキルにより生成）
│       │   └── draft/, todo/, in_progress/, review/, done/
│       │       └── D{ID}_T{ID}_{エージェント名}_{TITLE}.md  # タスクファイル
│       ├── proposals/         # 提案書置き場（setupスキルにより生成）
│       │   └── draft/, todo/, review/, approve/, reject/
│       │       └── P{ID}_{TITLE}.md  # 提案ファイル
│       └── questions/         # PdMへの質問事項置き場（setupスキルにより生成）
│           └── draft/, open/, answered/, resolved/
├── plugins/
│   └── my-workflow/           # Claude Code プラグイン
│       ├── .claude-plugin/    # プラグイン定義
│       │   └── plugin.json
│       ├── agents/            # サブエージェント定義
│       │   ├── product-owner.md
│       │   ├── tech-lead.md
│       │   └── developer.md
│       └── skills/            # スキル定義
│           ├── setup/         # 初期設定スキル
│           │   ├── SKILL.md
│           │   └── scripts/
│           │       ├── run-po.sh   # POエージェントの起動スクリプト
│           │       ├── run-tl.sh   # TLエージェントの起動スクリプト
│           │       └── run-dev.sh  # Devエージェントの起動スクリプト
│           ├── request  # 開発チームに対する要望を仕様に落とし込む（PO向け）
│           │   └── SKILL.md
│           ├── interview  # 質問内容をPdMに確認する（PO向け）
│           │   └── SKILL.md
│           ├── breakdown  # 仕様書をもとにタスクを作成する（TL向け）
│           │   └── SKILL.md
│           ├── review-task  # タスクの作業結果をレビューする（TL向け）
│           │   └── SKILL.md
│           ├── running-task  # タスクを進める（Dev向け）
│           │   └── SKILL.md
│           ├── acceptance  # 仕様書の検収をPdMに依頼する（PO向け）
│           │   └── SKILL.md
│           ├── shutdown  # 開発チームを停止する（PO向け）
│           │   └── SKILL.md
│           └── resume  # 質問の回答を受けて作業を再開する（TL向け）
│               └── SKILL.md
├── src/                     # メインソースコード
└── .claude/                 # Claude Code 設定

{任意}/  # エージェント用の作業ディレクトリ（起動スクリプトにより生成）
```

## 3. 並行開発と作業スペースの運用

### 3.1 外部ワークスペース (Git Worktree)

各Devエージェントは、project-root とは別の独立したディレクトリで作業を行う。

- **場所** : スクリプト起動時に引数として指定。
- **同期** : 作業開始時に必ず `git pull origin main` を実行し、最新の状態からブランチを切る（最新化の強制）。
- **分離** : 各worktree内に個別の `.claude/` セッションを保持する。

### 3.2 membersファイル

membersディレクトリに配置するファイルはマーカーファイル（存在チェック用）として扱う。ファイルの内容は空とする。ファイル名の形式は `{ロール}_{エージェント名}.md` とする。PdMがファイルを削除することでエージェントの停止を制御する（5.1 参照）。

### 3.3 状態管理（フォルダベースのステータス遷移）

エージェントは指定フォルダへのファイル移動をトリガーに自律動作する。

#### 監視方式

各スクリプトはポーリングによりディレクトリを監視する。ポーリング間隔は **5秒** とする。

#### 排他制御

タスクファイルのファイル名には担当エージェント名が含まれるため、各Devは自身のエージェント名が含まれるファイルのみを取得する。これにより、複数Devが同一タスクを取得する競合を回避する。

#### 仕様 (Designs) 遷移フロー

1. draft: POが作成し、PdMの承認を待つ。
2. todo: PdMが承認し、移動。TLによるタスク分割待ち。
3. in_progress: TLが検知して移動。このフェーズで `tasks/todo` にタスクが生成される。
4. review: TLが全タスクの完了を確認して移動。PdMによる最終検収待ち。全タスク完了の判定は、当該仕様書に紐づく全タスクファイル（`D{design-ID}_T*`）が `tasks/done` に存在することで行う。
5. done: PdMが承認し、最終完了。

#### タスク (Tasks) 遷移フロー

1. draft: TLが生成。依存タスクの作業完了待ち。
2. todo: TLが移動。Devの着手待ち。
3. in_progress: Devが検知して移動。実装着手中。
4. review: Devがコミット完了後、またはブロッカー発生時に移動。TLによるレビュー待ち。
5. done: TLがレビュー完了後に移動（マージ成功・不合格いずれも含む）。レビューで問題が見つかった場合は、修正用の新規タスクが別途作成される。

#### 提案 (Proposals) 遷移フロー 

1. draft: PO, TL, Devが生成。作成中。
2. todo: 作成者が移動。TLの確認待ち。
3. review: TLが検知して移動。TLによるレビュー中。
4. approve: レビュー結果が承認の場合、TLがレビュー完了後に移動。TLは提案内容に基づき、関連する仕様書の更新またはタスクの作成を行う。
5. reject: レビュー結果が却下の場合、TLがレビュー完了後に移動。却下理由を提案ファイルに追記する。


#### 質問 (Questions) 遷移フロー 

1. draft: TLが作成中。
2. open: TLが移動。PdMからの回答待ち。
3. answered: PdMから回答を得られたらPOが移動。TLの確認待ち。
4. resolved: TLが回答を確認して疑問が解決したらTLが移動。

## 4. コミュニケーション・プロトコル

### 4.1 エスカレーション & コンフリクト

- **仕様の矛盾** : TLが矛盾を検知した場合、POを通じてPdMに相談。
- **コンフリクト解決** : TLはマージ時に競合を検知した場合、自力で修正せず、該当タスクファイルに競合情報を追記して `tasks/todo` に戻す（担当Devへの差し戻し）。
- **Devからのエスカレーション** : Devが実装中にブロッカーや仕様の不明点に遭遇した場合、タスクファイルに問題内容を追記して `tasks/review` に移動する。TLがレビュー時に判断し、必要に応じて質問ファイルを作成してPdMに確認する。

### 4.2 命名規則

- **仕様書** : `D{yyyyMMddHHmmss}_{Title}.md` (例: `D20260208143000_Login-System.md` )
- **タスク** : `D{design-ID}_T{yyyyMMddHHmmss}_{Assignee}_{Title}.md` (例: `D20260208143000_T20260208150000_dev-a_Auth-Logic.md` )
- **提案** : `P{yyyyMMddHHmmss}_{Title}.md` (例: `P20260208160000_Update-Skill.md` )
- **質問** : `Q{yyyyMMddHHmmss}_{Title}.md` (例: `Q20260208170000_Auth-Scope.md` )

IDはタイムスタンプ（`yyyyMMddHHmmss`形式）で採番する。ファイル作成時点のタイムスタンプを使用することで、複数エージェントの同時作成時のID衝突を回避する。

### 4.3 ファイル内容

いずれもフロントマター付きのmarkdown形式とする。

#### 仕様書

- フロントマター
    - **title** : 仕様書タイトル
    - **created-at** : 作成日時
- 本文
    - 仕様内容

#### タスク

- フロントマター
    - **title** : タスクタイトル
    - **design-id** : 関連する仕様書のID
    - **assignee** : 担当エージェント名
    - **branch** : ブランチ名
    - **created-at** : 作成日時
    - **depends-on** : 依存するタスクのID一覧（任意）
- 本文
    - 作業内容
    - チェックリスト

#### 提案

- フロントマター
    - **title** : 提案タイトル
    - **author** : 作成者のエージェント名
    - **created-at** : 作成日時
- 本文
    - 提案内容

#### 質問

- フロントマター
    - **title** : 質問タイトル
    - **author** : 作成者のエージェント名
    - **related-to** : 関連する仕様書またはタスクのファイルパス
    - **created-at** : 作成日時
- 本文
    - 質問内容
    - 回答（PdMから回答を得た後にPOが追記）

## 5. Claude Code プラグイン実装仕様

### 5.1 エージェントのライフサイクル

#### 起動

1. PdMが `setup` スキルを実行し、ワークフロー基盤を初期化する。
2. PdMが各起動スクリプト（`run-po.sh`, `run-tl.sh`, `run-dev.sh`）を個別に実行する。

#### 停止

1. PdMがPOに停止を依頼する。
2. POが `shutdown` スキルを実行する。
    - `claude "/shutdown"`
    - membersディレクトリ内の全マーカーファイルを削除する。
3. TL・Devは次の監視サイクルで自身のファイルがないことを検知し終了する（停止チェックは全監視対象の中で最優先）。
4. POスクリプト自身も自身のファイルがないことを検知し終了する。

### 5.2 setupスキル

1. `.my-workflow` とそのサブディレクトリを作成。すでに存在する場合はスキップする（冪等性を保証）。
2. setupスキル配下のscriptsディレクトリ内スクリプトを `.my-workflow/scripts` にコピー。すでに存在する場合は上書きする。

### 5.3 PO向け自動実行スクリプト ( `run-po.sh` ) の責務

1. 引数で下記を受け取る
    - プロジェクトルートのパス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでにPOのファイルがある場合は終了
    - 自身のエージェント名のファイルがある場合も終了
3. ユーザー向けメッセージを表示
    - 「開発チームに対する要望があれば入力してください」
4. 対象ディレクトリとユーザー入力を監視
    - 監視対象（いずれもプロジェクトルート直下）。複数のイベントを同時に検知した場合は、以下の優先順位で処理する。
        1. エージェント一覧置き場: `.my-workflow/members`（停止チェック最優先）
        2. 質問置き場: `.my-workflow/work/questions/open`
        3. 検収待ちの仕様書置き場: `.my-workflow/work/designs/review`
5. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了
6. 質問ファイルを見つけたら下記を実施
    1. 質問に対する回答をユーザーに求める
        - `claude "/interview {質問ファイルのパス}"`
        - 回答を得られたら質問ファイルに回答を追記してansweredディレクトリに移動
    2. 「ユーザー向けメッセージを表示」に戻り再開
7. 検収待ちの仕様書ファイルを見つけたら下記を実施
    1. PdMに検収を依頼する
        - `claude "/acceptance {仕様書ファイルのパス}"`
        - PdMが承認したら仕様書ファイルを完了ディレクトリ( `.my-workflow/work/designs/done` )に移動
        - PdMが差し戻した場合は修正内容を仕様書に追記し、未着手ディレクトリ( `.my-workflow/work/designs/todo` )に戻す
    2. 「ユーザー向けメッセージを表示」に戻り再開
8. ユーザーから入力があったら下記を実施
    1. 停止依頼の場合
        - `claude "/shutdown"`
        - スクリプト終了
    2. それ以外の場合は要望を詳細化
        - `claude "/request {ユーザーからの入力}"`
    3. 「ユーザー向けメッセージを表示」に戻り再開

### 5.4 TL向け自動実行スクリプト ( `run-tl.sh` ) の責務

1. 引数で下記を受け取る
    - プロジェクトルートのパス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでにTLのファイルがある場合は終了
    - 自身のエージェント名のファイルがある場合も終了
3. 対象ディレクトリを監視
    - 監視対象（いずれもプロジェクトルート直下）。複数のイベントを同時に検知した場合は、以下の優先順位で処理する。
        1. エージェント一覧置き場: `.my-workflow/members`（停止チェック最優先）
        2. 回答済みの質問ファイル置き場: `.my-workflow/work/questions/answered`
        3. レビュー待ちのタスクファイル置き場: `.my-workflow/work/tasks/review`
        4. 未着手の仕様書置き場: `.my-workflow/work/designs/todo`
4. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了
5. 回答済みの質問ファイルを見つけたら下記を実施
    1. 回答を確認してタスクを再開
        - `claude --dangerously-skip-permissions -p "/resume {質問ファイルのパス}"`
        - 追加の質問がある場合は質問ファイルに質問を追記しopenディレクトリに移動する
        - 追加質問がなくタスク再開できるなら質問ファイルをresolvedディレクトリに移動する
            - 質問の元になった仕様書・タスクファイルに情報を追記し、todoディレクトリに移動する
                - 仕様書・タスクファイルは質問ファイルを参照
6. レビュー待ちのタスクファイルを見つけたら下記を実施
    1. レビュー開始
        - `claude --dangerously-skip-permissions -p "/review-task {タスクファイルのパス}"`
        - 作業結果を確認する
            - 作業結果に問題がなければmainブランチにマージして作業ブランチを削除する
                - 今回の作業完了により作業開始できるタスクがあれば、todoディレクトリに移動する
            - 作業結果に問題があれば問題の対応を行うタスクを新規作成する
                - 新規作成のタスクファイルに記載する作業ブランチはレビューしたタスクの作業ブランチと同じ
    2. タスクファイルを完了ディレクトリ( `.my-workflow/work/tasks/done` )に移動
    3. 監視に戻る
7. 未着手の仕様書ファイルを見つけたら下記を開始
    1. 仕様書ファイルを作業中ディレクトリ( `.my-workflow/work/designs/in_progress` )に移動
    2. タスクへの細分化を実施
        - `claude --dangerously-skip-permissions -p "/breakdown {仕様書ファイルのパス}"`
        - タスクファイルをdraftディレクトリに作成し、全て作成し終えたら着手可能なものをtodoディレクトリに移動する
        - PdMへの質問が必要な場合は質問ファイルを質問置き場（ `.my-workflow/work/questions/draft` ）に作成する
            - 質問ファイルは作成できたら open ディレクトリに移動する
            - 仕様書ファイルは draft ディレクトリに移動する。
    3. 監視に戻る

### 5.5 Dev向け自動実行スクリプト ( `run-dev.sh` ) の責務

1. 引数で下記を受け取る。
    - プロジェクトルートのパス
    - 作業ディレクトリ置き場のパス
    - エージェント名
2. membersディレクトリにファイル配置
    - すでに自身のエージェント名のファイルがある場合は終了
3. 対象ディレクトリを監視
    - 監視対象（いずれもプロジェクトルート直下）。複数のイベントを同時に検知した場合は、以下の優先順位で処理する。
        1. エージェント一覧置き場: `.my-workflow/members`（停止チェック最優先）
        2. タスクファイル置き場: `.my-workflow/work/tasks/todo`
4. エージェント一覧に自身のエージェント名のファイルが見つからない場合は下記を実施
    1. スクリプト終了
5. ファイル名に自身のエージェント名が含まれるタスクファイルを見つけたら下記を開始
    1. タスクファイルを作業中ディレクトリ( `.my-workflow/work/tasks/in_progress` )に移動
    2. 作業用ディレクトリを作成
        - `git worktree add {作業用ディレクトリのパス} {ブランチ名}`
        - 作業用ディレクトリのパス: `{作業ディレクトリ置き場}/{エージェント名}`
        - ブランチ名: タスクファイルに記載があればそのブランチを使用、記載がなければブランチを新規作成
            - 新規作成のブランチ名: `feature/{エージェント名}/{生成したUUID}`
    3. 作業ディレクトリに移動
    4. タスクの作業開始
        - `claude --dangerously-skip-permissions -p "/running-task {タスクファイルのパス}"`
        - 作業結果はタスクファイルに追記する
        - 必要に応じてコミットする
        - ブロッカーや仕様の不明点がある場合は、問題内容をタスクファイルに追記する
    5. プロジェクトルートに移動
    6. 作業用ディレクトリを削除
        - `git worktree remove {作業用ディレクトリのパス}`
    7. タスクファイルをレビューディレクトリ( `.my-workflow/work/tasks/review` )に移動
    8. 監視に戻る
